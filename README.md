# Implementing IaC in Jenkins CICD Pipeline
- Set Up Jenkins server in EC2 instance - refer to jenkins cicd repo for guide. 
- Install plugins for Node, Git and Terraform
- Configure settings for Terraform
- Install CloudBees AWS Credentials plugin
- Attempted to create a pipeline job within jenkins to run my terraform main.tf file to create instances
- Issues with jenkins not being able to find my terraform plugin so had to manually dial into jenkins and install terraform and configure the path within the Global Tool Configuration. 
- Add AWS Credentials (access and secret keys) in manage jenkins and Global Config settings

```
pipeline {
    agent any
    stages {
        stage('Remove files') {
            steps {
                sh 'rm -rf eng99_IaC_CICD'
            }
        }
        stage('Checkout') {
            steps {
                sh 'git clone https://github.com/RajsJohal/eng99_IaC_CICD.git'
            }
        }
        stage('Apply Terraform') {
            steps {
                dir('eng99_IaC_CICD/terraform') {
                    sh 'terraform init'
                    sh 'terraform apply --auto-approve'
                }
            }
        }
    }
}
```

## Ansible Integration
- Ansible Plugin, downloaded ansible and python on jenkins ec2 and added path to the binary folder where ansible lies. 
- Playbooks can be stored within jenkins, along with the vault and hosts file. 
- Jenkins server instance acts as a ansible controller
- Issue with being able to add the IP of the instances generated by terraform to the hosts file within the ansible controller in order to run the playbooks in the correct instance
- added the following command to the terraform script:
```
output "app_instance_ip" {
  value = aws_instance.app_instance.public_ip
}

output "db_instance_ip" {
  value = aws_instance.db_instance.public_ip
}
```
- This prints the IP of app and db instance whenever terraform apply is run 
- Need to add these IPs to the host file, either through echo or lineinfile command 
- `echo -e "[app]\nec2-instance ansible_host=$(terraform output app_instance_ip) ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/eng99.pem " | sed 's/"//g' > hosts` - adds instance ip to hosts file