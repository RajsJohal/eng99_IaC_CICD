# Implementing IaC in Jenkins CICD Pipeline
- Set Up Jenkins server in EC2 instance - refer to jenkins cicd repo for guide. 
- Install plugins for Node, Git and Terraform
- Configure settings for Terraform
- Install CloudBees AWS Credentials plugin
- Attempted to create a pipeline job within jenkins to run my terraform main.tf file to create instances
- Issues with jenkins not being able to find my terraform plugin so had to manually dial into jenkins and install terraform and configure the path within the Global Tool Configuration. 
- Add AWS Credentials (access and secret keys) in manage jenkins and Global Config settings
- added the following command to the terraform script:
```
output "app_instance_ip" {
  value = aws_instance.app_instance.public_ip
}

output "db_instance_ip" {
  value = aws_instance.db_instance.public_ip
}
```
- This prints the IP of app and db instance whenever terraform apply is run 

- Pipeline for terroform within jenkins
```
pipeline {
    agent any
    stages {
        stage('remove files') {
            steps {
                sh 'rm -rf eng99_IaC_CICD'
            }
        }
        stage('Checkout') {
            steps {
                sh 'git clone https://github.com/RajsJohal/eng99_IaC_CICD.git'
            }
        }
        stage('Apply Terraform'){
            steps {
                dir('eng99_IaC_CICD/terraform'){
                    sh 'terraform init'
                    sh 'terraform apply --auto-approve'
                    sh 'chmod +x ./hosts_config.sh'
                    sh './hosts_config.sh'
                }
            }
           
        }
    }
}
```
* The hosts_config.sh file contains the following code:
```
#!/bin/bash

echo -e "[app]\nec2-instance ansible_host=$(terraform output app_instance_ip) ansible_user=ubuntu" | sed 's/"//g' > hosts.inv

echo -e "[db]\nec2-instance ansible_host=$(terraform output db_instance_ip) ansible_user=ubuntu" | sed 's/"//g' >> hosts.inv
```
- Obtains the IP of both app and db ec2 instances and echoes into the hosts.inv to be used as a hosts file witin ansible in jenkins

## Ansible Integration
- Ansible Plugin, downloaded ansible and python on jenkins ec2 and added path to the binary folder where ansible lies. 
- Playbooks can be stored within jenkins, along with the vault and hosts file. 
- Jenkins server instance acts as a ansible controller
- Issue with being able to add the IP of the instances generated by terraform to the hosts file within the ansible controller in order to run the playbooks in the correct instance

## Ansible Playbook in Jenkins
- Create a new pipeline job within Jenkins 
- Create a pipeline script and use the pipeline syntax to create a git command to copy the repo and a ansible playbook job to run the playbook within the ec2 instances
```
pipeline {
    agent any
    stages{
        stage('remove repo') {
            steps {
                sh 'rm -rf eng99_IaC_CICD'
            }
        }
        stage('clone repo with playbooks'){
            steps{
                git branch: 'main', url: 'https://github.com/RajsJohal/eng99_IaC_CICD.git'
            }
            
        }
        stage('execute playbooks'){
            steps {
                ansiblePlaybook credentialsId: 'eng99_raj_ssh', disableHostKeyChecking: true, installation: 'ansible1', inventory: 'terraform/hosts.inv', playbook: 'playbooks/install_mongo.yml'
            }
            
        }
        stage('execute app setup playbook') {
            steps {
                ansiblePlaybook credentialsId: 'eng99_raj_ssh', disableHostKeyChecking: true, installation: 'ansible1', inventory: 'terraform/hosts.inv', playbook: 'playbooks/app_setup.yml'
            }
            
        }
        stage('execute nginx playbook') {
            steps {
                ansiblePlaybook credentialsId: 'eng99_raj_ssh', disableHostKeyChecking: true, installation: 'ansible1', inventory: 'terraform/hosts.inv', playbook: 'playbooks/install_nginx.yml'
            }
        }
        stage('execute app') {
            steps {
                ansiblePlaybook credentialsId: 'eng99_raj_ssh', disableHostKeyChecking: true, installation: 'ansible1', inventory: 'terraform/hosts.inv', playbook: 'playbooks/install_node.yml'
            }
        }
    }
}
```

- Pipeline script runs all the playbooks except for the last playbook which fails when trying to start application
- Issue with obtaining hosts.inv file when running terraform from jenkins, host.inv needs to be available in repo in order to provide path to the ansible playbook pipeline. 